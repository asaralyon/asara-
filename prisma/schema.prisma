// ===========================================
// ASARA  - Schéma de base de données
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Enums
// ===========================================

enum UserRole {
  ADMIN       // Administrateur
  PROFESSIONAL // Professionnel (100€/an)
  MEMBER      // Membre simple (15€/an)
}

enum UserStatus {
  PENDING     // En attente de validation
  ACTIVE      // Actif (cotisation à jour)
  EXPIRED     // Cotisation expirée
  SUSPENDED   // Suspendu
}

enum SubscriptionStatus {
  ACTIVE      // Abonnement actif
  PAST_DUE    // Paiement en retard
  CANCELED    // Annulé
  EXPIRED     // Expiré
}

enum PaymentStatus {
  PENDING     // En attente
  SUCCEEDED   // Réussi
  FAILED      // Échoué
  REFUNDED    // Remboursé
}

// ===========================================
// User Model
// ===========================================

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  passwordHash  String
  role          UserRole    @default(MEMBER)
  status        UserStatus  @default(PENDING)
  
  // Informations personnelles
  firstName     String
  lastName      String
  phone         String?
  address       String?
  city          String?
  postalCode    String?
  
  // Profil professionnel (uniquement pour PROFESSIONAL)
  profile       ProfessionalProfile?
  
  // Stripe
  stripeCustomerId String?  @unique
  
  // Relations
  subscriptions Subscription[]
  payments      Payment[]
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLoginAt   DateTime?
  
  // Email verification
  emailVerified Boolean     @default(false)
  emailVerifiedAt DateTime?
  
  @@index([email])
  @@index([status])
  @@index([role])
  @@map("users")
}

// ===========================================
// Professional Profile (pour l'annuaire)
// ===========================================

model ProfessionalProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informations professionnelles
  companyName     String?
  profession      String    // Ex: "Médecin", "Avocat", "Restaurateur"
  category        String    // Ex: "Santé", "Juridique", "Restauration"
  specialty       String?   // Ex: "Cardiologie", "Droit des affaires"
  description     String?   @db.Text
  
  // Coordonnées professionnelles
  address         String?
  city            String?
  postalCode      String?
  country         String    @default("France")
  latitude        Float?
  longitude       Float?
  
  // Contact professionnel
  professionalPhone String?
  professionalEmail String?
  website         String?
  
  // Réseaux sociaux
  linkedinUrl     String?
  facebookUrl     String?
  instagramUrl    String?
  
  // Images
  photoUrl        String?
  logoUrl         String?
  
  // Visibilité dans l'annuaire
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  
  // SEO
  slug            String    @unique
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([category])
  @@index([city])
  @@index([isPublished])
  @@index([slug])
  @@map("professional_profiles")
}

// ===========================================
// Categories (pour organiser les professions)
// ===========================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique // Ex: "Santé", "Juridique"
  slug        String    @unique
  description String?
  icon        String?   // Nom de l'icône Lucide
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("categories")
}

// ===========================================
// Subscription (Abonnements)
// ===========================================

model Subscription {
  id                  String              @id @default(cuid())
  userId              String
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Type d'abonnement
  type                UserRole            // PROFESSIONAL (100€) ou MEMBER (15€)
  
  // Stripe
  stripeSubscriptionId String?            @unique
  stripePriceId       String?
  
  // Période
  status              SubscriptionStatus  @default(ACTIVE)
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  
  // Annulation
  cancelAtPeriodEnd   Boolean             @default(false)
  canceledAt          DateTime?
  
  // Paiements liés
  payments            Payment[]
  
  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

// ===========================================
// Payment (Historique des paiements)
// ===========================================

model Payment {
  id                  String        @id @default(cuid())
  userId              String
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId      String?
  subscription        Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  // Montant
  amount              Int           // En centimes (10000 = 100€)
  currency            String        @default("eur")
  
  // Stripe
  stripePaymentIntentId String?     @unique
  stripeInvoiceId     String?       @unique
  
  // Statut
  status              PaymentStatus @default(PENDING)
  
  // Facture
  invoiceNumber       String?       @unique
  invoiceUrl          String?
  
  // Description
  description         String?
  
  // Timestamps
  createdAt           DateTime      @default(now())
  paidAt              DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ===========================================
// Email Templates
// ===========================================

model EmailTemplate {
  id          String    @id @default(cuid())
  name        String    @unique // Ex: "welcome", "renewal_reminder"
  subject     String
  htmlContent String    @db.Text
  textContent String?   @db.Text
  variables   String[]  // Ex: ["firstName", "renewalDate"]
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("email_templates")
}

// ===========================================
// Email Logs (pour suivi)
// ===========================================

model EmailLog {
  id          String    @id @default(cuid())
  to          String
  subject     String
  templateId  String?
  status      String    // "sent", "failed", "bounced"
  error       String?
  
  sentAt      DateTime  @default(now())
  
  @@index([to])
  @@index([sentAt])
  @@map("email_logs")
}

// ===========================================
// Settings (Configuration de l'app)
// ===========================================

model Setting {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    @db.Text
  description String?
  
  updatedAt   DateTime  @updatedAt
  
  @@map("settings")
}
model Event {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  type        EventType @default(GALLERY)
  
  // Pour type DOCUMENT
  documentUrl String?
  
  // Pour type GALLERY (max 3 images)
  imageUrl1   String?
  imageUrl2   String?
  imageUrl3   String?
  
  // Dates
  eventDate   DateTime?
  location    String?
  
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@map("events")
}

enum EventType {
  DOCUMENT
  GALLERY
}